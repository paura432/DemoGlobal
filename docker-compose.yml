services:
  demoglobal:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: demoglobal-app
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    
    environment:
      NODE_ENV: production
      # CR√çTICO: Limitar heap de Node.js
      NODE_OPTIONS: "--max-old-space-size=1536 --max-http-header-size=16384"
      NEXT_PUBLIC_VCS_API_URL: ${NEXT_PUBLIC_VCS_API_URL:-https://vcs.trustos.telefonicatech.com:9443}
      NEXT_PUBLIC_ENV_MODE: ${NEXT_PUBLIC_ENV_MODE:-prod}
      AUTH_SECRET: ${AUTH_SECRET}
      AUTH_URL: ${AUTH_URL:-http://localhost:3000/api/auth}
    
    # üî• ESTO ES CLAVE PARA EVITAR FREEZES
    deploy:
      resources:
        limits:
          cpus: '2'           # M√°ximo 2 CPUs
          memory: 2G          # M√°ximo 2GB RAM
        reservations:
          cpus: '0.5'         # M√≠nimo garantizado
          memory: 512M        # M√≠nimo garantizado
    
    # Healthcheck mejorado
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Limitar logs para no llenar disco
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - demoglobal-network

networks:
  demoglobal-network:
    driver: bridge